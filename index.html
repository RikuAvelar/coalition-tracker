<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Coalition Tracker</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css" integrity="sha512-xiunq9hpKsIcz42zt0o2vCo34xV0j6Ny8hgEylN3XBglZDtTZ2nwnqF/Z/TTCc18sGdvCjbFInNd++6q3J0N6g==" crossorigin="anonymous" />
        
        <script type="module">
            import { app } from 'https://unpkg.com/hyperapp'
            import html from 'https://unpkg.com/hyperlit'

            const version = '1.2.3';

            if (localStorage.getItem('lastVersion') !== version) {
                localStorage.setItem('lastVersion', version);
                localStorage.setItem('stateBackup', localStorage.getItem('state'));
                localStorage.setItem('extStateBackup', localStorage.getItem('extState'));
            }

            // Save Format
            // tuples of standing;questcompletion
            // courier;pioneer;mummer;inventor;peacekeeper;scout
            const colorWheel = (str) => {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                return Math.abs(hash) % 360;
            };
            const getMod = (str) => {
                if (!str) return ['45%', '65%'];
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
 
                return [
                    `${Math.floor((hash >> 16 & 0x000000FF) / 256 * 0.7 * 100 + 15)}%`,
                    `${Math.floor((hash >> 8 & 0x000000FF) / 256 * 0.30 * 100 + 45)}%`
                ];
            }
            const coalitionColor = (str, mod) => `hsla(${colorWheel(str)}, ${getMod(mod).join(',')}, 1)`;
            const questColor = (str, mod, lightness = '85%') => `hsla(${colorWheel(str)}, ${getMod(mod)[0]}, ${lightness}, 1)`;

            const ORDER = ['courier', 'pioneer', 'mummer', 'inventor', 'peacekeeper', 'scout'];
            const RANKS = {
                Petitioner: 0,
                Probationer: 1,
                Disciple: 2,
                Contributor: 3,

                Partner: 4,
                Advisor: 5,
                Magnate: 6,
                Legend: 7,
            };
            const RANKS_LUT = Object.entries(RANKS).reduce((obj, [rank, val]) => ({...obj, [val]: rank}), {})
            const savedState = (localStorage.getItem('state') || ORDER.map(() => '0;0').join(';')).split(';').map(Number);
            const savedStateExt = JSON.parse(localStorage.getItem('extState') || '{}');
            const QUESTS = {
                courier: {
                    'Supply Delivery': [
                        {
                            name: 'Deliver: Foret de Hennetiel',
                            link: 'https://www.bg-wiki.com/bg/Deliver:_Foret_de_Hennetiel',
                            rank: RANKS.Contributor,
                            text: 'Station â†’ Adoulin'
                        }
                     ]
                }
            }
            const FLAT_QUESTS = ORDER.reduce((obj, key) => (
                {
                    ...obj, 
                    [key]: Object.values(QUESTS[key]).reduce((arr, l) => [...arr, ...l])
                }
            ), {})
            const getInitialState = (state, stateEx) => ORDER.reduce((obj, key, index) => ({...obj, [key]: {
                standing: state[index * 2],
                completion: state[index * 2 + 1],
                activeQuests: stateEx?.[key]?.activeQuests ?? []
            }}), {
                editingFor: '',
                fastCD: stateEx?.fastCD
            });

            const saveToLocalStorage = (dispatch, props) => {
                localStorage.setItem('state', ORDER.map(key => `${props[key].standing};${props[key].completion}`).join(';'))
                localStorage.setItem('extState', JSON.stringify(props))
            }

            const saveState = (props) => [saveToLocalStorage, props]

            const coalitionName = (key) => `${key[0].toUpperCase()}${key.slice(1)}'s Coalition`
            const getRank = (rank) => Math.max(0, Math.min(7, Math.floor(rank / 20)));
            const getRankNameFromStanding = (rank) => RANKS_LUT[getRank(rank)]

            const isQuestAvailable = (state, coalition, quest) => (
                getRank(state[coalition].standing) >= quest.rank &&
                !(
                    getRank(state[coalition].standing) >= RANKS.Contributor && (getRank(state[coalition].standing) - quest.rank > 1)
                )
            );

            const isQuestActive = (state, coalition, quest) => state[coalition].activeQuests?.includes(FLAT_QUESTS[coalition].indexOf(quest));

            const isQuestComplete = (state, coalition, quest) => {
                const questIndex = FLAT_QUESTS[coalition].indexOf(quest);

                return !!((state[coalition].completion >> questIndex) & 1);
            }

            const timeAsString = (totalHours) => {
                const months = Math.floor(totalHours / (24 * 30));
                const days = Math.floor((totalHours - (months * 24 * 30)) / 24);
                const hours = totalHours - (months * 24 * 30) - (days * 24);

                const monthText = months > 0 ? `${months} month${months > 1 ? 's' : ''}` : '';
                const dayText = days > 0 ? `${days} day${days > 1 ? 's' : ''}` : '';
                const hourText = `${hours} hour${hours === 1 ? '' : 's'}`;

                return [monthText, dayText, hourText].filter(v => !!v).join(', ');
            }

            const isAllAdvisor = (state) => ORDER.every((key) => state[key].standing >= 100);
            const imprimaturCD = (state) => state.fastCD && isAllAdvisor(state) ? 5.5 : 6;

            const coalitionTimeLeftTillLegend = (state, coalition) => timeAsString(imprimaturCD(state) * Math.max(0, 140 - state[coalition].standing));

            const timeLeftTillLegend = (state) => {
                const totalTime = ORDER.reduce((total, key) => total + Math.max(0, 140 - state[key].standing), 0) * imprimaturCD(state);
                return timeAsString(totalTime);
            }
            const dateOfLegend = (state) => {
                const totalTime = ORDER.reduce((total, key) => total + Math.max(0, 140 - state[key].standing), 0) * imprimaturCD(state);
                const date = new Date(Date.now() + totalTime * 60 * 60 * 1000);
                return new Intl.DateTimeFormat('en', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}).format(date);
            }

            const updateStandingReducer = (state, event) => ({...state, editingFor: '', [state.editingFor]: {...state[state.editingFor], standing: Number(event.target.value)}});
            const onStandingKey = (state, event) => {
                if (event.key === 'Enter') {
                    return updateStanding(state, event);
                }

                if (event.key === 'Escape') {
                    return {...state, editingFor: ''};
                }

                return state;
            }

            const clearSelection = () => {
                if (window.getSelection) {
                    if (window.getSelection().empty) {
                        window.getSelection().empty();
                    } else if (window.getSelection().removeAllRanges) { 
                        window.getSelection().removeAllRanges();
                    }
                }
            };

            const toggleQuestCompletionReducer = (state, coalition, quest) => ({
                ...state,
                [coalition]: {
                    ...state[coalition],
                    // XOR will toggle the quest
                    completion: state[coalition].completion ^ (1 << FLAT_QUESTS[coalition].indexOf(quest))
                }
            });

            const activateQuestCompletionReducer = (state, coalition, quest) => ({
                ...state,
                [coalition]: {
                    ...state[coalition],
                    // OR will activate the quest
                    completion: state[coalition].completion | (1 << FLAT_QUESTS[coalition].indexOf(quest)),
                    activeQuests: state[coalition].activeQuests.filter(v => v !== FLAT_QUESTS[coalition].indexOf(quest))
                }
            });
            

            const activateQuestStateReducer = (state, coalition, quest) => ({
                ...state,
                [coalition]: {
                    ...state[coalition],
                    activeQuests: [...state[coalition].activeQuests, FLAT_QUESTS[coalition].indexOf(quest)]
                }
            });
            

            const deactivateQuestStateReducer = (state, coalition, quest) => ({
                ...state,
                [coalition]: {
                    ...state[coalition],
                    activeQuests: state[coalition].activeQuests.filter(v => v !== FLAT_QUESTS[coalition].indexOf(quest))
                }
            });

            const updateStanding = (state, event) => [
                updateStandingReducer(state, event),
                saveState(updateStandingReducer(state, event))
            ];

            const toggleQuestCompletion = (state, coalition, quest, event) => {
                if (event) {
                    event.stopPropagation();
                }
                const newState = toggleQuestCompletionReducer(state, coalition, quest);
                return [
                    newState,
                    saveState(newState)
                ];
            };
            

            const performQuest = (state, coalition, quest, event) => {
                if (event) {
                    event.preventDefault();
                }
                const currentStanding = state[coalition].standing;
                const editingState = {...state, editingFor: coalition};
                const newState = updateStandingReducer(activateQuestCompletionReducer(editingState, coalition, quest), {target: {value: currentStanding + 3}});
                clearSelection();
                return [
                    newState,
                    saveState(newState),
                ];
            };

            const activateQuest = (state, coalition, quest, event) => {
                if (event) {
                    event.preventDefault();
                }

                const questState = isQuestActive(state, coalition, quest);
                
                if (questState) {
                    return performQuest(state, coalition, quest, event);
                }
                
                const newState = activateQuestStateReducer(state, coalition, quest);
                return [
                    newState,
                    saveState(newState),
                ];
            };
            

            const deactivateQuest = (state, coalition, quest, event) => {
                if (event) {
                    event.preventDefault();
                }
                
                const newState = deactivateQuestStateReducer(state, coalition, quest);
                return [
                    newState,
                    saveState(newState),
                ];
            };

            const noopPropStop = (state, event) => {
                if (event) {
                    event.stopPropagation();
                }

                return state;
            }

            const toggleSpeed = (state) => ({...state, fastCD: !state?.fastCD});
            
            const promptState = (state) => {
                const newState = prompt(`Add save data below (current version: ${version}`, localStorage.getItem('state'));
                if (!newState) {
                    return state;
                }
                try {
                    const imported = getInitialState(newState.split(';').map(Number));
                    return [imported, saveState(imported)];
                } catch {
                    console.error('There was an error importing this state:', newState);
                    return state;
                }
            }

            const standingTracker = (state, coalition) => html`
                ${
                    state.editingFor === coalition ?
                        html`<input value=${state[coalition].standing} onchange=${updateStanding} onkeydown=${onStandingKey} />` :
                        html`<small class="clickable" onclick=${state => ({...state,editingFor: coalition})}>(<span class="spaced">${state[coalition].standing}</span>)</small>`
                }
            `;

            const speedToggleButton = (state) => isAllAdvisor(state) ? html`
                <div class="toggle-speed" title="Toggle faster imprimatur cooldown" onclick=${(state) => toggleSpeed(state)}>
                    <input class="hidden" type="checkbox" checked=${!!state.fastCD} />
                    <span data-icon="shovel" data-inline="false"></span>
                    <span class="preloader" data-icon="preload-shovel" data-inline="false"></span>
                </div>
            ` : '';

            app({
                init: getInitialState(savedState, savedStateExt),
                view: state => html`
                    <main>
                        <nav>
                            <h1 ondblclick=${promptState}>Coalition Tracker 
                            <div class="info-container">
                                <small title=${dateOfLegend(state)}>Legend in : ${timeLeftTillLegend(state)}</small>
                                <br />
                                <small><a href="https://github.com/RikuAvelar/coalition-tracker/blob/master/changelog.md" target="_blank">v${version}</a></small>
                                <small><a title="How to use this tracker" href="https://github.com/RikuAvelar/coalition-tracker/blob/master/readme.md" target="_blank">View Readme</a></small>
                            </div>
                            </h1>
                            ${speedToggleButton(state)}
                            ${ORDER.map(coalition => html`
                                <a class="nav-link" href="#${coalition}" style=${{'--primary-color': coalitionColor(coalition)}}>${coalitionName(coalition).slice(0, -12)}</a>
                            `)}
                        </nav>
                        <div class="coalitions">
                        ${Object.entries(QUESTS).map(([coalition, quests]) => html`
                            <h2 id="${coalition}" style=${{color: coalitionColor(coalition)}}>
                                ${coalitionName(coalition)}
                                <small class="extra-small">Legend in: ${coalitionTimeLeftTillLegend(state, coalition)}</small><br />
                                <div class="subtitle">
                                    <small>${getRankNameFromStanding(state[coalition].standing)}</small>
                                    ${standingTracker(state, coalition)}<br />
                                </div>
                            </h2>
                            <div class="coalition">
                            ${Object.entries(quests).map(([type, quests]) => html`
                                <div class="type">
                                    <h3 style=${{color: coalitionColor(coalition, type)}}>${type}</h3>
                                    <blockquote style=${{borderColor: coalitionColor(coalition, type)}}>
                                    ${quests.map((quest) => html`
                                        <div 
                                            class="quest ${isQuestAvailable(state, coalition, quest) ? '' : 'unavailable'} ${isQuestActive(state, coalition, quest) ? 'active' : ''}"
                                            onclick=${(state) => activateQuest(state, coalition, quest, event)}
                                            oncontextmenu=${(state) => deactivateQuest(state, coalition, quest, event)}
                                            style=${{'--bg-color': questColor(coalition, type), '--bg-color-light': questColor(coalition, type, '95%'), '--bg-color-dark': questColor(coalition, type, '75%')}}
                                        >
                                            <h4><a onclick=${noopPropStop} href=${quest.link} target="_blank">${quest.name}</a> <small>${RANKS_LUT[quest.rank]}</small></h4>
                                            <small>${quest.text}</small>
                                            <input type="checkbox" checked=${isQuestComplete(state, coalition, quest)} onclick=${(state, event) => toggleQuestCompletion(state, coalition, quest, event)} />
                                        </div>
                                    `)}
                                    </blockquote>
                                </div>
                            `)}
                            </div>
                        <hr style={${{borderColor: coalitionColor(coalition)}} />
                        `)}
                        </div>
                    </main>`,
                node: document.getElementById('app')
            })
        </script>
    </head>
    <body>
        <main id="app"></main>
    </body>
</html>
